<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crea Vedio - 智能创作工作台</title>
    <style>
        :root {
            /* 2026 高级灰配色体系 - Refined */
            --primary: #6366f1; /* Indigo-500 */
            --primary-light: #eef2ff;
            --primary-hover: #4f46e5;
            /* 渐变色：更现代的流动感渐变 */
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            
            /* 背景色：更有质感的灰，加深一点以便突显卡片 */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-panel: #ffffff;
            
            /* 文字颜色 */
            --text-main: #0f172a;
            --text-sub: #64748b;
            
            /* 边框：几乎透明，主要靠阴影 */
            --border: #e2e8f0;
            
            /* 功能色 */
            --danger: #ef4444;
            --success: #10b981;
            --warning-bg: #fffbeb;
            --warning-text: #b45309;
            
            /* 阴影：增加一点浓度，让层次更分明 */
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.08);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.08);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.08);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.08);
            
            /* 圆角 */
            --radius: 16px;
            --radius-lg: 24px;
            --radius-sm: 8px;
            
            --slider-color: #6366f1; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; letter-spacing: -0.01em; }

        /* Icons */
        .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; fill: none; }
        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 28px; height: 28px; stroke-width: 1.2; }

        /* Utilities */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* 新增动画效果 */
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.6); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* 页面加载动画 */
        body {
            animation: fadeIn 0.6s ease-out;
        }
        
        /* 卡片进入动画 */
        .control-card {
            animation: slideInRight 0.5s ease-out backwards;
        }
        .control-card:nth-child(1) { animation-delay: 0.1s; }
        .control-card:nth-child(2) { animation-delay: 0.2s; }
        .control-card:nth-child(3) { animation-delay: 0.3s; }
        .control-card:nth-child(4) { animation-delay: 0.4s; }
        
        /* 侧边栏动画 */
        .panel {
            animation: slideInLeft 0.5s ease-out;
        }
        .panel:last-child {
            animation: slideInRight 0.5s ease-out;
        }
        
        /* 音色卡片动画 */
        .voice-card {
            animation: scaleIn 0.3s ease-out backwards;
        }
        .voice-card:nth-child(1) { animation-delay: 0.1s; }
        .voice-card:nth-child(2) { animation-delay: 0.15s; }
        .voice-card:nth-child(3) { animation-delay: 0.2s; }
        
        /* 按钮点击动画 */
        .btn-primary:active {
            animation: scaleIn 0.2s ease-out;
        }
        
        /* 输入框聚焦动画 */
        .main-textarea:focus {
            animation: glow 2s ease-in-out infinite;
        }
        
        /* 标签页切换动画 */
        .tab-btn {
            position: relative;
            overflow: hidden;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .tab-btn:active::after {
            width: 300px;
            height: 300px;
        }
        
        /* 滑动条动画增强 */
        .slider-progress {
            animation: shimmer 2s linear infinite;
            background-size: 200% 100%;
        }
        
        /* 历史记录项动画 */
        .feed-item {
            animation: slideInRight 0.4s ease-out backwards;
        }
        .feed-item:nth-child(1) { animation-delay: 0.05s; }
        .feed-item:nth-child(2) { animation-delay: 0.1s; }
        .feed-item:nth-child(3) { animation-delay: 0.15s; }
        
        /* 徽章动画 */
        .preset-badge, .clone-badge {
            animation: scaleIn 0.3s ease-out;
        }
        
        /* 图标悬停动画 */
        .icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .voice-card:hover .icon {
            animation: bounce 0.6s ease-in-out;
        }
        
        /* 生成按钮加载动画 */
        .btn-primary.loading {
            position: relative;
            overflow: hidden;
        }
        .btn-primary.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* 音色切换动画 */
        .voice-card.active {
            animation: scaleIn 0.3s ease-out;
        }
        
        /* 上传区域动画 */
        .upload-compact-label {
            position: relative;
            overflow: hidden;
        }
        .upload-compact-label::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }
        .upload-compact-label:hover::before {
            animation: shimmer 1s linear;
            opacity: 1;
        }
        
        /* 数值显示动画 */
        .bp-val-display, .es-val {
            transition: all 0.3s;
        }
        .bp-val-display:active, .es-val:active {
            animation: bounce 0.3s ease-out;
        }
        
        /* 进度条动画 */
        .slider-progress {
            transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 结果卡片出现动画 */
        .result-card {
            animation: slideInRight 0.5s ease-out;
        }
        
        /* 模态框动画增强 */
        .modal-box {
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Toast 动画增强 */
        .toast {
            animation: slideInRight 0.3s ease-out, fadeIn 0.3s ease-out;
        }
        
        /* 重置按钮动画 */
        .es-reset {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .es-reset:active {
            animation: spin 0.5s ease-out;
        }
        
        /* 字符计数动画 */
        .char-count {
            transition: all 0.3s;
        }
        .char-count:active {
            animation: bounce 0.3s ease-out;
        }
        
        /* 标签页切换动画增强 */
        .tab-btn.active {
            animation: scaleIn 0.2s ease-out;
        }
        
        /* 卡片内容切换动画 */
        .card-body > div {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* 音色图标播放动画 */
        .voice-card.playing .voice-icon {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* 生成历史点击动画 */
        .feed-card:active {
            animation: scaleIn 0.2s ease-out;
        }
        
        /* 操作图标动画 */
        .action-icon:active {
            animation: bounce 0.3s ease-out;
        }

        /* Header */
        header { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px);
            border-bottom: none; 
            padding: 0 24px; 
            height: 64px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-shrink: 0; 
            z-index: 50; 
            box-shadow: var(--shadow-sm);
        }
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--text-main); 
            letter-spacing: -0.02em; 
            cursor: pointer;
            transition: transform 0.2s;
        }
        .logo-badge {
            font-size: 0.75rem;
            background: var(--primary-light);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 600;
            margin-left: 8px;
        }
        .logo:hover { transform: scale(1.02); }
        .logo svg { 
            color: var(--primary); 
            filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.2));
            transition: transform 0.3s;
        }
        .logo:hover svg { transform: rotate(5deg); }
        
        .user-profile { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            cursor: pointer; 
            transition: all 0.2s;
            padding: 8px 12px;
            border-radius: 10px;
        }
        .user-profile:hover { 
            background: var(--bg-body);
            transform: translateY(-1px);
        }
        .credits-pill { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; cursor: pointer; }
        .credits-val { 
            font-size: 0.875rem; 
            font-weight: 600; 
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .credits-val span { 
            color: var(--primary); 
            background: var(--primary-light);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 700;
        }
        .credits-exp { font-size: 0.7rem; color: var(--text-sub); }
        .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: 2px solid #fff; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 0 0 2px var(--primary-light); 
            object-fit: cover;
            transition: all 0.2s;
        }
        .user-profile:hover .avatar {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3), 0 0 0 2px var(--primary);
        }

        /* Layout */
        .workspace { flex: 1; display: grid; grid-template-columns: 280px 1fr 300px; height: calc(100vh - 64px); overflow: hidden; }
        .panel { display: flex; flex-direction: column; height: 100%; border-right: none; background: #fff; box-shadow: 1px 0 0 0 var(--border); }
        .panel:last-child { border-right: none; }
        .panel-bg { background: var(--bg-body); }
        .panel-header { 
            padding: 16px 20px; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.95rem; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            color: var(--text-main); 
            background: linear-gradient(to right, #fff, #fafbfc);
            position: relative;
        }
        .filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }
        .panel-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--primary), transparent);
            opacity: 0.3;
        }

        /* Sidebar Voice List */
        .voice-list-container { overflow-y: auto; padding: 16px; }
        .voice-card { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid transparent; 
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }
        .voice-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        .voice-card:hover::before {
            left: 100%;
        }
        .voice-card:hover { 
            background: var(--bg-body); 
            border-color: var(--border);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }
        .voice-card.active { 
            background: linear-gradient(135deg, #eef2ff, #e0e7ff); 
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
        }
        
        /* 音色头像试听样式增强 */
        .voice-icon { 
            width: 40px; 
            height: 40px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
            position: relative; 
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .voice-card:hover .voice-icon {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .voice-card.active .voice-icon {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .voice-play-overlay { 
            position: absolute; 
            inset: 0; 
            background: rgba(255,255,255,0.25); 
            backdrop-filter: blur(6px); 
            -webkit-backdrop-filter: blur(6px);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            opacity: 0; 
            transition: all 0.3s; 
            color: #fff;
            border-radius: inherit;
        }
        .voice-card:hover .voice-play-overlay, .voice-card.playing .voice-play-overlay,
        .lib-item:hover .voice-play-overlay, .lib-item.playing .voice-play-overlay { 
            opacity: 1; 
        }
        .voice-card.playing .voice-play-overlay, .lib-item.playing .voice-play-overlay { 
            background: rgba(99, 102, 241, 0.4); 
        }
        .voice-card.playing .voice-icon, .lib-item.playing .voice-icon {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }
            50% { 
                transform: scale(1.08);
                box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
            }
        }

        .v-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #ffffff; }
        .v-pink { background: linear-gradient(135deg, #ec4899, #db2777); color: #ffffff; }
        .v-orange { background: linear-gradient(135deg, #f97316, #ea580c); color: #ffffff; }
        .v-purple { background: linear-gradient(135deg, #a855f7, #9333ea); color: #ffffff; }
        .voice-info { flex: 1; min-width: 0; }
        .voice-name { font-size: 0.9rem; font-weight: 500; color: var(--text-main); margin-bottom: 2px;}
        .voice-tag { font-size: 0.75rem; color: var(--text-sub); display: inline-flex; align-items: center; gap: 4px;}

        /* Main Stage */
        .stage-container { 
            padding: 24px; 
            padding-bottom: 40px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            max-width: 900px; 
            margin: 0 auto; 
            width: 100%; 
            flex: 1 1 0%; /* 强制收缩: flex-grow: 1, flex-shrink: 1, flex-basis: 0% */
            min-height: 0; 
        }

        /* 固定的底部操作栏 */
        .fixed-action-bar {
            position: relative;
            flex-shrink: 0;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
        }
        
        html.dark-mode .fixed-action-bar {
            background: rgba(24, 24, 27, 0.9);
            border-top-color: var(--border);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
        }

        .action-bar-inner {
            width: 100%;
            max-width: 900px;
        }
        .control-card { 
            background: #fff; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            border: none; 
            overflow: hidden; 
            margin-bottom: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .control-card:hover {
            box-shadow: var(--shadow-lg);
        }
        .card-tabs { 
            display: flex; 
            border-bottom: 1px solid var(--border); 
            background: linear-gradient(to bottom, #fafbfc, #f8fafc);
            position: relative;
        }
        .tab-btn { 
            flex: 1; 
            padding: 14px; 
            font-size: 0.9rem; 
            color: var(--text-sub); 
            cursor: pointer; 
            text-align: center; 
            border-bottom: 2px solid transparent; 
            font-weight: 500; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            position: relative;
        }
        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 60%;
            height: 2px;
            background: var(--primary);
            transition: transform 0.3s;
        }
        .tab-btn:hover { 
            color: var(--text-main); 
            background: #f1f5f9;
        }
        .tab-btn.active { 
            color: var(--primary); 
            background: #fff;
        }
        .tab-btn.active::before {
            transform: translateX(-50%) scaleX(1);
        }
        .card-body { padding: 24px; }
        .card-header-text { 
            font-size: 1rem; 
            font-weight: 700; 
            margin-bottom: 16px; 
            color: var(--text-main); 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }

        /* Preset & Clone UI */
        .preset-display { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            background: linear-gradient(135deg, #eef2ff, #e0e7ff); 
            border: 1px solid #c7d2fe; 
            padding: 18px; 
            border-radius: 12px; 
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
        }
        .preset-display:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
            transform: translateY(-1px);
        }
        .clone-display { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            background: linear-gradient(135deg, #faf5ff, #f3e8ff); 
            border: 1px solid #d8b4fe; 
            padding: 18px; 
            border-radius: 12px; 
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(147, 51, 234, 0.15);
        }
        .clone-display:hover {
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.25);
            transform: translateY(-1px);
        }
        .preset-badge { background: #fff; color: var(--primary); font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .clone-badge { background: #fff; color: #9333ea; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Upload Container */
        .upload-compact-label { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            border: 1px dashed var(--border); 
            border-radius: 8px; 
            padding: 30px; 
            color: var(--text-sub); 
            background: #f8fafc; 
            transition: all 0.2s; 
            width: 100%; 
            cursor: pointer; 
        }
        .upload-compact-label:hover { 
            border-color: var(--primary); 
            background: linear-gradient(135deg, #ecfdf5, #d1fae5); 
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .upload-compact-label svg {
            transition: transform 0.3s;
        }
        .upload-compact-label:hover svg {
            transform: translateY(-2px) scale(1.1);
        }
        
        .re-upload-text { font-size: 0.8rem; color: #9333ea; text-decoration: underline; cursor: pointer; margin-left: auto; }
        
        /* Emotion Styles */
        .emotion-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .emotion-slider-item { 
            background: #f8fafc; 
            border: 1px solid transparent; 
            padding: 16px; 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            transition: all 0.3s;
        }
        .emotion-slider-item:hover {
            background: #fff;
            border-color: var(--primary-light);
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }
        .es-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; }
        .es-label { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; color: var(--text-main); }
        .es-val { font-family: monospace; font-size: 0.85rem; color: var(--primary); background: #fff; padding: 2px 8px; border-radius: 6px; border: 1px solid var(--border); font-weight: 600;}
        .es-reset { cursor: pointer; color: var(--text-sub); opacity: 0.6; transition: 0.2s; width: 16px; height: 16px;}
        .es-reset:hover { opacity: 1; color: var(--primary); transform: rotate(90deg); }
        .global-weight { margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border); }
        .random-check { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; font-size: 0.9rem; cursor: pointer; user-select: none; }
        .random-check input { width: 16px; height: 16px; accent-color: var(--primary); }
        .default-state-box { 
            text-align: center; 
            padding: 40px 30px; 
            background: linear-gradient(135deg, #ffffff, #f8fafc); 
            border-radius: 12px; 
            border: 2px dashed var(--border); 
            color: var(--text-sub);
            transition: all 0.3s;
        }
        .default-state-box:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eef2ff, #e0e7ff);
        }
        .default-state-box svg {
            transition: transform 0.3s;
        }
        .default-state-box:hover svg {
            transform: scale(1.1) rotate(5deg);
        }

        /* Basic Params */
        .basic-param-row { 
            margin-bottom: 24px; 
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        .basic-param-row:hover {
            background: #fff;
            border-color: var(--primary-light);
            box-shadow: var(--shadow-sm);
        }
        .basic-param-row:last-child { margin-bottom: 0; }
        .bp-label-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .bp-badge { 
            background: transparent; 
            color: var(--text-main); 
            padding: 0; 
            font-size: 0.95rem; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .bp-badge svg {
            color: var(--primary);
            filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.2));
        }
        .bp-input-group { display: flex; align-items: center; gap: 16px; }
        .bp-slider-track { flex: 1; }
        .bp-val-display { 
            background: #fff; 
            border: 1px solid var(--border); 
            padding: 4px 12px; 
            border-radius: 8px; 
            font-size: 0.9rem; 
            font-family: monospace; 
            min-width: 54px; 
            text-align: center; 
            box-shadow: var(--shadow-sm);
            font-weight: 600;
            color: var(--primary);
        }
        .bp-helper { font-size: 0.8rem; color: var(--text-sub); margin-top: 4px; padding-left: 2px; }

        /* Sliders - 重新设计 */
        input[type=range] { 
            -webkit-appearance: none;
            appearance: none;
            width: 100%; 
            background: transparent; 
            cursor: pointer;
            height: 8px;
            position: relative;
            margin: 12px 0;
        }
        input[type=range]:focus { outline: none; }
        
        /* Track - 轨道背景 */
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; 
            height: 8px; 
            background: transparent;
            border-radius: 10px; 
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: transparent;
            border-radius: 10px;
        }
        
        /* Thumb - 滑块 */
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none;
            height: 20px; 
            width: 20px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            margin-top: -9px; 
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4), 0 0 0 3px rgba(99, 102, 241, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid #fff;
            cursor: grab;
            position: relative;
            box-sizing: border-box;
        }
        input[type=range]::-webkit-slider-thumb:hover { 
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5), 0 0 0 4px rgba(99, 102, 241, 0.15);
        }
        input[type=range]::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.15);
        }
        
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4), 0 0 0 3px rgba(99, 102, 241, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid #fff;
            cursor: grab;
            box-sizing: border-box;
        }
        input[type=range]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5), 0 0 0 4px rgba(99, 102, 241, 0.15);
        }
        
        /* 滑动条包装器，用于显示进度 */
        .slider-container {
            position: relative;
            width: 100%;
            height: 8px;
            margin: 12px 0;
            display: flex;
            align-items: center;
        }
        .slider-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 8px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 10px;
            pointer-events: none;
            z-index: 1;
            transition: width 0.1s linear;
            box-shadow: 0 1px 4px rgba(99, 102, 241, 0.4);
        }
        .slider-container input[type=range] {
            position: relative;
            z-index: 2;
        }
        
        /* 滑动条背景轨道 */
        .slider-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
            z-index: 0;
        }
        
        /* 情感滑动条特殊背景 */
        .emotion-slider-item .slider-container::before {
            background: #f1f5f9;
        }
        
        /* 基础参数滑动条特殊背景 */
        .bp-slider-track .slider-container::before {
            background: #f8fafc;
        }

        /* Inputs & Buttons */
        .input-wrapper { position: relative; }
        .main-textarea { 
            width: 100%; 
            min-height: 140px; 
            padding: 16px; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            font-size: 1rem; 
            line-height: 1.6; 
            resize: vertical; 
            outline: none; 
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.02); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: block;
            background: #f8fafc;
        }
        .main-textarea:focus { 
            border-color: var(--primary); 
            background: #fff;
            box-shadow: 0 0 0 3px var(--primary-light), var(--shadow-md);
            transform: translateY(-1px);
        }
        .char-count { position: absolute; bottom: 12px; right: 12px; font-size: 0.75rem; color: var(--text-sub); background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px; pointer-events: none;}
        
        .action-bar { display: flex; gap: 16px; align-items: center; margin-top: 10px; }
        .btn-primary { 
            flex: 1; 
            height: 48px; 
            background: var(--primary-gradient); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 1rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.4); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px 0 rgba(99, 102, 241, 0.5);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-primary:disabled { 
            background: #cbd5e1; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }

        /* Result Card & Progress Bar */
        .result-card { border: none; background: #fff; border-radius: var(--radius); padding: 20px; display: flex; align-items: center; gap: 16px; box-shadow: var(--shadow-md); }
        .play-btn-circle { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            background: var(--primary-gradient); 
            border: none; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            flex-shrink: 0; 
            position: relative;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .play-btn-circle:hover { 
            transform: scale(1.1); 
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
        }
        .play-btn-circle:active {
            transform: scale(0.95);
        }
        
        /* 音符跳动动画增强 */
        .visualizer { display: flex; align-items: flex-end; gap: 2px; height: 16px; position: absolute; }
        .visualizer span { width: 2px; height: 100%; background: #fff; border-radius: 1px; transform-origin: bottom; animation: bar-jump 0.6s ease-in-out infinite alternate; display: none; }
        .isPlaying .visualizer span { display: block; }
        .visualizer span:nth-child(2) { animation-delay: 0.1s; }
        .visualizer span:nth-child(3) { animation-delay: 0.2s; }
        .visualizer span:nth-child(4) { animation-delay: 0.15s; }
        @keyframes bar-jump { from { transform: scaleY(0.3); } to { transform: scaleY(1); } }

        .progress-container { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .progress-track { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; position: relative; cursor: pointer; }
        .progress-fill { position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: var(--primary); border-radius: 3px; transition: width 0.1s linear; }
        .progress-thumb { position: absolute; top: 50%; right: 0; width: 12px; height: 12px; background: #fff; border: 2px solid var(--primary); border-radius: 50%; transform: translate(50%, -50%); box-shadow: var(--shadow-sm); }
        .time-display { font-size: 0.75rem; color: var(--text-sub); font-family: monospace; min-width: 40px; text-align: right; }

        /* History */
        .history-feed { padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .feed-item { position: relative; padding-left: 24px; }
        .feed-line { position: absolute; left: 7px; top: 24px; bottom: -24px; width: 1px; background: var(--border); }
        .feed-item:last-child .feed-line { display: none; }
        .feed-dot { position: absolute; left: 0; top: 4px; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 2px solid var(--primary); }
        .feed-card { 
            background: #fff; 
            border: 1px solid transparent; 
            border-radius: 12px; 
            padding: 16px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .feed-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s;
        }
        .feed-card:hover { 
            border-color: var(--primary); 
            box-shadow: var(--shadow-md); 
            transform: translateX(4px);
            background: linear-gradient(to right, #eef2ff, #ffffff);
        }
        .feed-card:hover::before {
            transform: scaleY(1);
        }
        .feed-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 8px; }
        .feed-text { font-size: 0.85rem; color: var(--text-main); line-height: 1.4; margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .feed-actions { display: flex; justify-content: flex-end; gap: 8px; align-items: center;}
        .cost-badge { 
            color: var(--danger); 
            font-size: 0.7rem; 
            background: linear-gradient(135deg, #fee2e2, #fecaca); 
            padding: 4px 8px; 
            border-radius: 6px; 
            margin-right: auto;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
        }
        .action-icon { 
            padding: 6px; 
            border-radius: 6px; 
            color: var(--text-sub); 
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-icon:hover { 
            background: var(--primary-light); 
            color: var(--primary);
            transform: scale(1.1);
        }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #1f2937; color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 1000; box-shadow: var(--shadow-md); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box { background: #fff; padding: 24px; border-radius: var(--radius); width: 320px; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.open .modal-box { transform: scale(1); }
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; }
        .modal-desc { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 16px; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; font-size: 1rem; outline: none; transition: border-color 0.2s; background: #f8fafc; }
        .modal-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px var(--primary-light); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 8px; }
        .btn-text { padding: 8px 12px; font-size: 0.9rem; color: var(--text-sub); cursor: pointer; border-radius: 6px; background: transparent; border: none; }
        .btn-text:hover { background: #f1f5f9; color: var(--text-main); }
        .btn-confirm { padding: 8px 16px; font-size: 0.9rem; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; border: none; font-weight: 500; }
        .btn-confirm:hover { background: var(--primary-hover); }

        .modal-box-lg { background: #fff; padding: 0; border-radius: var(--radius-lg); width: 800px; max-width: 90vw; height: 600px; display: flex; flex-direction: column; box-shadow: var(--shadow-xl); transform: scale(0.95); transition: transform 0.2s; overflow: hidden; }
        .modal-overlay.open .modal-box-lg { transform: scale(1); }
        .lib-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .lib-title { font-size: 1.25rem; font-weight: 700; color: var(--text-main); }
        .lib-close { cursor: pointer; color: var(--text-sub); transition: color 0.2s; }
        .lib-close:hover { color: var(--text-main); }
        
        .lib-nav { padding: 0 24px; border-bottom: 1px solid var(--border); display: flex; gap: 24px; }
        .lib-nav-item { padding: 16px 0; font-weight: 500; color: var(--text-sub); cursor: pointer; position: relative; }
        .lib-nav-item.active { color: var(--primary); }
        .lib-nav-item.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--primary); }
        
        .lib-content { flex: 1; overflow-y: auto; padding: 24px; background: #f8fafc; }
        .lib-search-bar { display: flex; gap: 12px; margin-bottom: 20px; }
        .lib-search-input { flex: 1; padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; outline: none; background: #fff; }
        .lib-search-input:focus { border-color: var(--primary); }
        .lib-filter-btn { padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: var(--text-main); cursor: pointer; display: flex; align-items: center; gap: 6px; }
        
        .lib-tags { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .lib-tag { padding: 6px 12px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; color: var(--text-sub); cursor: pointer; transition: all 0.2s; }
        .lib-tag:hover, .lib-tag.active { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        .lib-list { display: flex; flex-direction: column; gap: 12px; }
        .lib-item { background: #fff; border: 1px solid transparent; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; transition: all 0.2s; box-shadow: var(--shadow-sm); }
        .lib-item:hover { border-color: transparent; box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .lib-item-icon { width: 48px; height: 48px; border-radius: 8px; background: #eee; object-fit: cover; }
        .lib-item-info { flex: 1; }
        .lib-item-name { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
        .lib-item-desc { font-size: 0.85rem; color: var(--text-sub); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .lib-item-tags { display: flex; gap: 6px; margin-top: 8px; }
        .lib-item-tag { font-size: 0.75rem; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; color: var(--text-sub); }
        
        .lib-item-actions { display: flex; gap: 12px; align-items: center; }
        .btn-select { padding: 8px 20px; background: var(--text-main); color: #fff; border-radius: 20px; font-size: 0.9rem; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-select:hover { background: #000; transform: scale(1.05); }
        .btn-select.selected { background: var(--primary); pointer-events: none; }
        
        .emo-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
        .emo-btn { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 24px; 
            border: 1px solid transparent; 
            border-radius: 16px; 
            background: #fff; 
            width: 100%; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            box-shadow: var(--shadow-sm);
        }
        .emo-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md); 
            border-color: transparent;
        }
        .emo-btn-icon-wrapper { 
            width: 48px; 
            height: 48px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0;
            transition: all 0.3s;
        }
        .emo-btn-icon-wrapper.blue { background: #eef2ff; color: #6366f1; }
        .emo-btn-icon-wrapper.pink { background: #fff1f2; color: #f43f5e; }
        
        .emo-btn:hover .emo-btn-icon-wrapper { transform: scale(1.1); }
        
        .emo-btn-content { flex: 1; }
        .emo-btn-title { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
        .emo-btn-desc { font-size: 0.85rem; color: var(--text-sub); }
        
        .emo-selected-display { display: flex; align-items: center; gap: 12px; padding: 16px; background: #fff; border: 1px solid var(--border); border-radius: 12px; margin-top: 16px; position: relative; }
        .emo-remove { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #fff; border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-sub); box-shadow: var(--shadow-sm); }
        .emo-remove:hover { color: var(--danger); border-color: var(--danger); }

        @media (max-width: 768px) { .emotion-grid { grid-template-columns: 1fr; } }
        /* Filter Modal Styles */
        .filter-grid { display: grid; gap: 24px; padding: 12px 0; }
        .filter-group-title { font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px; }
        .filter-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        
        /* Select */
        .custom-select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 0.9rem; color: var(--text-main); outline: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; cursor: pointer; transition: border-color 0.2s; }
        .custom-select:focus { border-color: var(--primary); }
        
        /* Segmented Control */
        .segmented-control { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .seg-item { flex: 1; text-align: center; padding: 8px; font-size: 0.9rem; color: var(--text-sub); cursor: pointer; border-radius: 6px; transition: all 0.2s; font-weight: 500; }
        .seg-item:hover { color: var(--text-main); }
        .seg-item.active { background: #fff; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: 600; }
        
        /* Tags */
        .filter-tags { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-tag { padding: 8px 16px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; color: var(--text-sub); cursor: pointer; transition: all 0.2s; background: #fff; }
        .filter-tag:hover { border-color: var(--primary); color: var(--primary); }
        .filter-tag.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); font-weight: 500; }
        
        .modal-footer { margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; align-items: center; }
        .btn-reset { color: var(--text-sub); font-size: 0.9rem; cursor: pointer; padding: 8px 16px; border-radius: 8px; background: transparent; border: none; transition: color 0.2s; }
        .btn-reset:hover { color: var(--text-main); background: #f1f5f9; }

        /* Layout Fixes */
        .voice-list-container, .stage-container, .history-feed {
            flex: 1;
            min-height: 0;
        }

        /* Dark Mode - Pure Black Theme Refined */
        html.dark-mode {
            --bg-body: #09090b; /* Zinc-950 */
            --bg-card: #18181b; /* Zinc-900 */
            --bg-panel: #18181b; /* Zinc-900 */
            --text-main: #f4f4f5; /* Zinc-100 */
            --text-sub: #a1a1aa; /* Zinc-400 */
            --border: #27272a; /* Zinc-800 */
            --primary-light: #312e81; /* Indigo-900 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.8);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.8);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.9);
            --warning-bg: #451a03;
            --warning-text: #fbbf24;
        }
        
        /* 1. 全局容器与背景 */
        html.dark-mode header { background: rgba(24, 24, 27, 0.8); border-bottom-color: var(--border); }
        html.dark-mode .panel { background: var(--bg-panel); border-right-color: var(--border); box-shadow: none; }
        html.dark-mode .panel-header { background: var(--bg-panel); border-bottom-color: var(--border); color: var(--text-main); }
        html.dark-mode .lib-content { background: var(--bg-body); }
        
        /* 2. 卡片容器 (Level 1) */
        html.dark-mode .control-card,
        html.dark-mode .result-card,
        html.dark-mode .modal-box,
        html.dark-mode .modal-box-lg {
            background: var(--bg-card);
            border-color: var(--border);
            color: var(--text-main);
        }
        
        /* 3. 输入框与次级模块 (Level 2 - Lighter than card) */
        html.dark-mode .main-textarea, 
        html.dark-mode .modal-input, 
        html.dark-mode .lib-search-input,
        html.dark-mode .custom-select,
        html.dark-mode .basic-param-row,
        html.dark-mode .emotion-slider-item,
        html.dark-mode .upload-compact-label,
        html.dark-mode .default-state-box,
        html.dark-mode .preset-display, 
        html.dark-mode .clone-display,
        html.dark-mode .bp-val-display,
        html.dark-mode .es-val,
        html.dark-mode .feed-card,
        html.dark-mode .lib-item,
        html.dark-mode .emo-btn,
        html.dark-mode .filter-tag,
        html.dark-mode .lib-item-tag,
        html.dark-mode .segmented-control {
            background: #27272a; /* Zinc-800 */
            border-color: #3f3f46; /* Zinc-700 */
            color: var(--text-main);
        }
        
        /* 4. 交互状态优化 */
        html.dark-mode .tab-btn:hover { background: #27272a; }
        html.dark-mode .tab-btn.active { background: #18181b; color: var(--primary); } /* 标签页激活与卡片同色 */
        html.dark-mode .card-tabs { background: #09090b; border-bottom-color: var(--border); } /* 标签栏背景更深 */
        
        html.dark-mode .basic-param-row:hover,
        html.dark-mode .emotion-slider-item:hover,
        html.dark-mode .voice-card:hover,
        html.dark-mode .lib-item:hover,
        html.dark-mode .emo-btn:hover,
        html.dark-mode .upload-compact-label:hover {
            background: #3f3f46; /* Zinc-700 */
            border-color: #52525b; /* Zinc-600 */
        }
        
        html.dark-mode .voice-card.active,
        html.dark-mode .seg-item.active,
        html.dark-mode .filter-tag.active {
            background: #3730a3; /* Indigo-900 */
            border-color: var(--primary);
            color: #e0e7ff;
        }
        
        html.dark-mode .slider-container::before { background: #3f3f46; }
        html.dark-mode .bp-slider-track .slider-container::before { background: #3f3f46; }
        html.dark-mode .emotion-slider-item .slider-container::before { background: #3f3f46; }
        html.dark-mode .bp-badge { color: var(--text-main); }
        html.dark-mode .char-count { background: rgba(39, 39, 42, 0.8); color: var(--text-sub); }
        
        /* Dark Mode Toggle */
        .theme-toggle { padding: 8px; border-radius: 8px; cursor: pointer; color: var(--text-sub); transition: all 0.2s; margin-right: 16px; display: flex; align-items: center; justify-content: center; }
        .theme-toggle:hover { background: var(--primary-light); color: var(--primary); }

    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="window.location.reload()">
            <span>Crea Vedio</span>
            <span class="logo-badge">Pro 2.0</span>
        </div>
        <div style="flex:1"></div>
        <a href="后台.html?page=library" style="margin-right: 16px; font-size: 0.9rem; font-weight: 600; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--primary-light); border-radius: 8px; transition: all 0.2s;">
            <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            资源库管理
        </a>
        <div class="theme-toggle" onclick="toggleTheme()" title="切换深色模式">
            <svg class="icon" viewBox="0 0 24 24" id="theme-icon">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </div>
        <div class="user-profile" id="user-profile-btn" onclick="openActivationModal()">
            <div class="credits-pill">
                <div class="credits-val">积分: <span id="credit-count">2,450</span></div>
                <div class="credits-exp" id="header-exp-text">点击输入激活码</div>
            </div>
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="avatar" alt="User">
        </div>
    </header>

    <div class="workspace">
        <aside class="panel">
            <div class="panel-header">
                <span>音色库</span>
                <button class="filter-btn" onclick="openFilterModal()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                    筛选
                </button>
            </div>
            <div class="voice-list-container">
                <div class="voice-card active" data-name="沉稳高管" data-color="v-blue">
                    <div class="voice-icon v-blue">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                    </div>
                    <div class="voice-info"><div class="voice-name">沉稳高管</div><div class="voice-tag">商务 · 中文</div></div>
                </div>
                <div class="voice-card" data-name="新闻女声" data-color="v-pink">
                    <div class="voice-icon v-pink">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                    </div>
                    <div class="voice-info"><div class="voice-name">新闻女声</div><div class="voice-tag">播音 · 快速</div></div>
                </div>
                <div class="voice-card" data-name="有声书男" data-color="v-orange">
                    <div class="voice-icon v-orange">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                    </div>
                    <div class="voice-info"><div class="voice-name">有声书男</div><div class="voice-tag">磁性 · 叙述</div></div>
                </div>
            </div>
        </aside>

        <section class="panel panel-bg">
            <div class="stage-container">
                
                <div class="control-card">
                    <div class="card-tabs">
                        <div class="tab-btn active" onclick="switchTab('preset', 'voice-card-body')">
                            <span>使用库音色</span>
                        </div>
                        <div class="tab-btn" onclick="switchTab('upload', 'voice-card-body')">
                            <span>克隆</span>
                        </div>
                    </div>
                    <div class="card-body" id="voice-card-body">
                        
                        <div id="panel-preset" class="preset-display fade-in">
                            <div id="current-voice-icon" class="voice-icon v-blue" style="width:48px; height:48px; border-radius:12px;">
                                <svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            </div>
                            <div style="flex:1">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span id="current-voice-name" style="font-weight:600; font-size:1rem;">沉稳高管</span>
                                    <span class="preset-badge">当前选择</span>
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-sub); margin-top:4px;">已应用该音色配置，点击左侧列表可快速切换。</div>
                            </div>
                        </div>
                        
                        <div id="panel-clone-container" class="hidden">
                            <label for="file-clone-input" id="clone-upload-state" class="upload-compact-label fade-in">
                                <svg class="icon icon-lg" style="color:var(--primary)" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                <span style="font-weight:500; color:var(--text-main)">点击上传克隆参考音频</span>
                                <span style="font-size:0.8rem">支持 MP3, WAV (3-10秒)</span>
                            </label>
                            <input type="file" id="file-clone-input" style="display: none;" accept="audio/*" onchange="handleFileSelect(this)">

                            <div id="clone-active-state" class="clone-display hidden fade-in">
                                <div class="voice-icon v-purple" style="width:48px; height:48px; border-radius:12px;">
                                    <svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                                </div>
                                <div style="flex:1">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <span id="custom-voice-name" style="font-weight:600; font-size:1rem;">My_Voice.wav</span>
                                        <span class="clone-badge">自定义克隆</span>
                                    </div>
                                    <div style="font-size:0.85rem; color:var(--text-sub); margin-top:4px;">正在使用本地上传的音色进行生成。</div>
                                </div>
                                <label for="file-clone-input" class="re-upload-text">更换文件</label>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="control-card">
                    <div class="card-tabs">
                        <div class="tab-btn active" onclick="switchEmotionTab('default')">
                            <span>默认</span>
                        </div>
                        <div class="tab-btn" onclick="switchEmotionTab('manual')">
                            <span>情感控制</span>
                        </div>
                        <div class="tab-btn" onclick="switchEmotionTab('reference')">
                            <span>情感参考</span>
                        </div>
                        <div class="tab-btn" onclick="switchEmotionTab('text')">
                            <span>情感文本</span>
                        </div>
                    </div>
                    <div class="card-body">
                        
                        <div id="emo-default" class="fade-in">
                            <div style="padding: 12px 0;">
                                <div style="font-weight:600; color:var(--text-main); margin-bottom:6px; font-size:1rem;">智能情感模式</div>
                                <div style="font-size:0.9rem; color:var(--text-sub); line-height:1.5;">不应用任何特殊情感设置，AI 将根据文本上下文自然演绎。</div>
                            </div>
                        </div>

                        <div id="emo-manual" class="hidden fade-in">
                            <label class="random-check"><input type="checkbox" id="random-emo" onchange="toggleRandom(this)"><span>随机产生情感变化</span></label>
                            
                            <div class="emotion-grid">
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">喜悦</div><div class="es-val" id="val-joy">0.0</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-joy')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-joy"></div>
                                        <input type="range" id="s-joy" min="0" max="1" step="0.1" value="0" oninput="updateVal(this, 'val-joy')">
                                    </div>
                                </div>
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">吉祥</div><div class="es-val" id="val-auspicious">0.0</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-auspicious')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-auspicious"></div>
                                        <input type="range" id="s-auspicious" min="0" max="1" step="0.1" value="0" oninput="updateVal(this, 'val-auspicious')">
                                    </div>
                                </div>
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">愤怒</div><div class="es-val" id="val-anger">0.0</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-anger')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-anger"></div>
                                        <input type="range" id="s-anger" min="0" max="1" step="0.1" value="0" oninput="updateVal(this, 'val-anger')">
                                    </div>
                                </div>
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">低落</div><div class="es-val" id="val-depressed">0.0</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-depressed')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-depressed"></div>
                                        <input type="range" id="s-depressed" min="0" max="1" step="0.1" value="0" oninput="updateVal(this, 'val-depressed')">
                                    </div>
                                </div>
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">悲伤</div><div class="es-val" id="val-sad">0.0</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-sad')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-sad"></div>
                                        <input type="range" id="s-sad" min="0" max="1" step="0.1" value="0" oninput="updateVal(this, 'val-sad')">
                                    </div>
                                </div>
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">惊喜</div><div class="es-val" id="val-surprise">0.0</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-surprise')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-surprise"></div>
                                        <input type="range" id="s-surprise" min="0" max="1" step="0.1" value="0" oninput="updateVal(this, 'val-surprise')">
                                    </div>
                                </div>
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">恐惧</div><div class="es-val" id="val-fear">0.0</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-fear')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-fear"></div>
                                        <input type="range" id="s-fear" min="0" max="1" step="0.1" value="0" oninput="updateVal(this, 'val-fear')">
                                    </div>
                                </div>
                                <div class="emotion-slider-item">
                                    <div class="es-head"><div class="es-label">平静</div><div class="es-val" id="val-calm">0.5</div><svg class="icon es-reset" viewBox="0 0 24 24" onclick="resetSlider('s-calm')"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></div>
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-s-calm"></div>
                                        <input type="range" id="s-calm" min="0" max="1" step="0.1" value="0.5" oninput="updateVal(this, 'val-calm')">
                                    </div>
                                </div>
                            </div>
                            <div class="global-weight">
                                <div class="es-head"><div class="es-label">情感权重</div><div class="es-val" id="val-global">1.00</div></div>
                                <div class="slider-container">
                                    <div class="slider-progress" id="progress-s-global"></div>
                                    <input type="range" id="s-global" min="0" max="1.5" step="0.05" value="1.0" oninput="updateVal(this, 'val-global')">
                                </div>
                            </div>
                        </div>

                        <div id="emo-reference" class="hidden fade-in">
                            <div class="emotion-header" style="background:var(--primary-light); color:var(--primary); border-color:#c7d2fe; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem; display: flex; gap: 8px; align-items: flex-start;">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" style="flex-shrink:0; margin-top:2px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                <span>请选择参考情感来源，或上传包含目标语气的音频。</span>
                            </div>
                            
                            <!-- 两个按钮 -->
                            <div class="emo-btn-group" id="emo-btn-group">
                                <div class="emo-btn" onclick="openEmotionLibrary()">
                                    <div class="emo-btn-icon-wrapper blue">
                                        <svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z"></path><path d="M10 8h4a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h.01"></path></svg>
                                    </div>
                                    <div class="emo-btn-content">
                                        <div class="emo-btn-title">情绪库</div>
                                        <div class="emo-btn-desc">浏览预设情感</div>
                                    </div>
                                </div>
                                <label for="file-emo-input" class="emo-btn">
                                    <div class="emo-btn-icon-wrapper pink">
                                        <svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                    </div>
                                    <div class="emo-btn-content">
                                        <div class="emo-btn-title">本地上传</div>
                                        <div class="emo-btn-desc">支持 WAV, MP3</div>
                                    </div>
                                </label>
                            </div>
                            
                            <input type="file" id="file-emo-input" style="display: none;" accept="audio/*" onchange="handleEmoFileSelect(this)">

                            <!-- 选中状态显示区域 (初始隐藏) -->
                            <div id="emo-selected-container" class="hidden">
                                <div class="emo-selected-display">
                                    <div class="voice-icon v-orange" style="width:40px; height:40px; border-radius:8px;" id="emo-sel-icon">
                                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                                    </div>
                                    <div style="flex:1">
                                        <div style="font-weight:600; font-size:0.95rem;" id="emo-sel-title">文件名/情感名</div>
                                        <div style="font-size:0.8rem; color:var(--text-sub);" id="emo-sel-desc">来源: 本地上传</div>
                                    </div>
                                    <div class="emo-remove" onclick="resetEmoSelection()">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="emo-text" class="hidden fade-in">
                             <div class="input-wrapper">
                                <textarea id="emotion-text-input" class="main-textarea" style="min-height: 100px;" placeholder="在此输入用于生成情感的文本..." maxlength="100"></textarea>
                                <div class="char-count"><span id="emo-char-num">0</span> / 100</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-card">
                    <div class="card-body">
                        <div class="card-header-text">基础参数</div>
                        <div class="basic-param-row">
                            <div class="bp-label-row">
                                <div class="bp-badge">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 14v-4"></path><path d="M12 2a10 10 0 0 0-8.66 15"></path><path d="M20.66 17A10 10 0 0 0 12 2"></path>
                                    </svg> 
                                    语速
                                </div>
                                <div style="flex:1"></div>
                                <div class="bp-val-display" id="disp-speed">1.0</div>
                                <svg class="icon icon-sm es-reset" viewBox="0 0 24 24" onclick="resetBasicParam('speed', 1.0)"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                            </div>
                            <div class="bp-input-group">
                                <span style="font-size:0.8rem; color:var(--text-sub)">0.8</span>
                                <div class="bp-slider-track">
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-param-speed"></div>
                                        <input type="range" id="param-speed" min="0.8" max="2.5" step="0.1" value="1.0" oninput="updateBasicParam('speed', this.value)">
                                    </div>
                                </div>
                                <span style="font-size:0.8rem; color:var(--text-sub)">2.5</span>
                            </div>
                        </div>
                        <div class="basic-param-row">
                            <div class="bp-label-row">
                                <div class="bp-badge">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                    </svg> 
                                    音量
                                </div>
                                <div style="flex:1"></div>
                                <div class="bp-val-display" id="disp-vol">1</div>
                                <svg class="icon icon-sm es-reset" viewBox="0 0 24 24" onclick="resetBasicParam('vol', 1)"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                            </div>
                            <div class="bp-input-group">
                                <span style="font-size:0.8rem; color:var(--text-sub)">0.1</span>
                                <div class="bp-slider-track">
                                    <div class="slider-container">
                                        <div class="slider-progress" id="progress-param-vol"></div>
                                        <input type="range" id="param-vol" min="0.1" max="2" step="0.1" value="1" oninput="updateBasicParam('vol', this.value)">
                                    </div>
                                </div>
                                <span style="font-size:0.8rem; color:var(--text-sub)">2</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-card">
                    <div class="input-wrapper">
                        <textarea id="text-input" class="main-textarea" placeholder="在此输入您想要生成的文本内容..."></textarea>
                        <div class="char-count"><span id="char-num">0</span> / 500</div>
                    </div>
                </div>

                <div id="result-card" class="result-card hidden fade-in">
                    <button id="main-play-btn" class="play-btn-circle" onclick="togglePlay(this)">
                        <div class="visualizer">
                            <span></span><span></span><span></span><span></span>
                        </div>
                        <svg class="icon icon-sm play-icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <svg class="icon icon-sm pause-icon hidden" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                    <div class="progress-container">
                        <div class="progress-track" id="audio-track" onclick="seekAudio(event)">
                            <div class="progress-fill" id="audio-progress">
                                <div class="progress-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <div class="time-display" id="time-current">00:00</div>
                    <div style="display:flex; gap:8px;">
                         <button class="action-icon" onclick="showToast('已开始下载')"><svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                    </div>
                </div>
            </div>
            
            <div class="fixed-action-bar">
                <div class="action-bar-inner">
                    <div class="action-bar" style="margin-top:0;">
                        <button id="btn-generate" class="btn-primary" onclick="startGeneration()">
                            <span class="btn-text" style="color:white; padding:0;">立即生成</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <aside class="panel">
            <div class="panel-header"><span>生成历史</span><span id="history-count" style="font-size:0.8rem; background:#f1f5f9; padding:2px 8px; border-radius:10px;">3</span></div>
            <div class="history-feed" id="history-feed-container">
                <div class="feed-item"><div class="feed-dot"></div><div class="feed-line"></div><div class="feed-card" onclick="copyTextToInput(this)"><div class="feed-meta"><span>Voice_01.wav</span><span>2026-01-20 12:34:59</span></div><div class="feed-text">Translate for me, what is a surprise! This is a demo text.</div><div class="feed-actions"><span class="cost-badge">-5 pts</span><div class="action-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div></div></div></div>
                <div class="feed-item"><div class="feed-dot" style="border-color:var(--text-sub)"></div><div class="feed-line"></div><div class="feed-card" onclick="copyTextToInput(this)"><div class="feed-meta"><span>Voice_02.wav</span><span>2026-01-20 10:24:15</span></div><div class="feed-text">The palace is strict, no false rumors allowed inside.</div><div class="feed-actions"><span class="cost-badge">-8 pts</span><div class="action-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div></div></div></div>
                <div class="feed-item"><div class="feed-dot" style="border-color:var(--text-sub)"></div><div class="feed-card" onclick="copyTextToInput(this)"><div class="feed-meta"><span>Voice_03.wav</span><span>2026-01-19 14:20:33</span></div><div class="feed-text">这个呀，就是我们精心制作准备的纪念品...</div><div class="feed-actions"><span class="cost-badge">-12 pts</span><div class="action-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div></div></div></div>
            </div>
        </aside>

    </div>

    <div id="activation-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">激活高级账号</div>
            <div class="modal-desc">请输入您的邀请码以获取更多积分。</div>
            <input type="text" class="modal-input" id="invite-code" placeholder="输入邀请码">
            <div class="modal-actions">
                <button class="btn-text" onclick="closeActivationModal()">取消</button>
                <button class="btn-confirm" onclick="submitActivationCode()">激活</button>
            </div>
        </div>
    </div>

    <div id="emotion-lib-modal" class="modal-overlay">
        <div class="modal-box-lg">
            <div class="lib-header">
                <div class="lib-title">情绪库</div>
                <div class="lib-close" onclick="closeEmotionLibrary()">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div class="lib-content">
                <div class="lib-tags" style="margin-bottom: 20px;">
                    <div class="lib-tag active" onclick="filterEmo(this)">全部</div>
                    <div class="lib-tag" onclick="filterEmo(this)">喜悦</div>
                    <div class="lib-tag" onclick="filterEmo(this)">愤怒</div>
                    <div class="lib-tag" onclick="filterEmo(this)">悲伤</div>
                    <div class="lib-tag" onclick="filterEmo(this)">恐惧</div>
                    <div class="lib-tag" onclick="filterEmo(this)">惊讶</div>
                    <div class="lib-tag" onclick="filterEmo(this)">烦躁</div>
                    <div class="lib-tag" onclick="filterEmo(this)">欣慰</div>
                    <div class="lib-tag" onclick="filterEmo(this)">焦虑</div>
                </div>
                <div class="lib-list">
                    <!-- Item 1 -->
                    <div class="lib-item" data-name="新闻女声">
                        <div class="voice-icon" style="width:48px; height:48px; border-radius:8px; margin-right:0;">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Jessica" style="width:100%; height:100%; object-fit:cover;">
                            <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                        </div>
                        <div class="lib-item-info">
                            <div class="lib-item-name">新闻女声 - 明亮圆润,干练利落,新闻现场感</div>
                            <div class="lib-item-desc">这是一个端庄大气的女声。其声线明亮圆润且富有知性美，说话节奏抑扬顿挫。</div>
                            <div class="lib-item-tags">
                                <span class="lib-item-tag">中文-普通话</span>
                                <span class="lib-item-tag">标准口音</span>
                                <span class="lib-item-tag">+5</span>
                            </div>
                        </div>
                        <div class="lib-item-actions">
                            <button class="btn-select" onclick="selectEmotionFromLib('新闻女声', '端庄大气', 'https://api.dicebear.com/7.x/avataaars/svg?seed=Jessica')">选择</button>
                        </div>
                    </div>
                    <!-- Item 2 -->
                    <div class="lib-item" data-name="港普空姐">
                        <div class="voice-icon" style="width:48px; height:48px; border-radius:8px; margin-right:0;">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah" style="width:100%; height:100%; object-fit:cover;">
                            <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                        </div>
                        <div class="lib-item-info">
                            <div class="lib-item-name">港普空姐 - 清脆明亮,快言快语,直爽且真实</div>
                            <div class="lib-item-desc">这是一个充满活力的女声。其声线清脆明亮，说话节奏快言快语，十分...</div>
                            <div class="lib-item-tags">
                                <span class="lib-item-tag">中文-普通话</span>
                                <span class="lib-item-tag">中国-南方</span>
                                <span class="lib-item-tag">+3</span>
                            </div>
                        </div>
                        <div class="lib-item-actions">
                            <button class="btn-select" onclick="selectEmotionFromLib('港普空姐', '清脆明亮', 'https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah')">选择</button>
                        </div>
                    </div>
                    <!-- Item 3 -->
                    <div class="lib-item" data-name="沉稳高管">
                        <div class="voice-icon" style="width:48px; height:48px; border-radius:8px; margin-right:0;">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=John" style="width:100%; height:100%; object-fit:cover;">
                            <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                        </div>
                        <div class="lib-item-info">
                            <div class="lib-item-name">沉稳高管 - 低沉厚实,磁性,从容不迫</div>
                            <div class="lib-item-desc">这是一个沉稳干练的男声。其声线低沉厚实且自带磁性，说话节奏从容不迫...</div>
                            <div class="lib-item-tags">
                                <span class="lib-item-tag">中文-普通话</span>
                                <span class="lib-item-tag">标准口音</span>
                                <span class="lib-item-tag">+5</span>
                            </div>
                        </div>
                        <div class="lib-item-actions">
                            <button class="btn-select" onclick="selectEmotionFromLib('沉稳高管', '低沉厚实', 'https://api.dicebear.com/7.x/avataaars/svg?seed=John')">选择</button>
                        </div>
                    </div>
                     <!-- Item 4 -->
                    <div class="lib-item" data-name="不羁青年">
                        <div class="voice-icon" style="width:48px; height:48px; border-radius:8px; margin-right:0;">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Mike" style="width:100%; height:100%; object-fit:cover;">
                            <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                        </div>
                        <div class="lib-item-info">
                            <div class="lib-item-name">不羁青年 - 低沉磁性,慵懒随意,霸道</div>
                            <div class="lib-item-desc">这是一个极具辨识度的青年男声。其声线低沉磁性且略带冷冽，说话节奏...</div>
                            <div class="lib-item-tags">
                                <span class="lib-item-tag">中文-普通话</span>
                                <span class="lib-item-tag">标准口音</span>
                                <span class="lib-item-tag">+6</span>
                            </div>
                        </div>
                        <div class="lib-item-actions">
                            <button class="btn-select" onclick="selectEmotionFromLib('不羁青年', '低沉磁性', 'https://api.dicebear.com/7.x/avataaars/svg?seed=Mike')">选择</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="filter-modal" class="modal-overlay">
        <div class="modal-box" style="width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div class="modal-title" style="margin:0; font-size:1.2rem;">语音过滤器</div>
                <div class="lib-close" onclick="closeFilterModal()">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            
            <div class="filter-grid">


                <div>
                    <div class="filter-group-title">性别</div>
                    <div class="segmented-control">
                        <div class="seg-item active" onclick="selectSeg(this)">全部</div>
                        <div class="seg-item" onclick="selectSeg(this)">男</div>
                        <div class="seg-item" onclick="selectSeg(this)">女</div>
                    </div>
                </div>

                <div>
                    <div class="filter-group-title">年龄</div>
                    <div class="filter-tags">
                        <div class="filter-tag" onclick="toggleTag(this)">儿童</div>
                        <div class="filter-tag" onclick="toggleTag(this)">青年</div>
                        <div class="filter-tag" onclick="toggleTag(this)">中年</div>
                        <div class="filter-tag" onclick="toggleTag(this)">老年</div>
                    </div>
                </div>

                <div>
                    <div class="filter-group-title">类别</div>
                    <div class="filter-tags">
                        <div class="filter-tag" onclick="toggleTag(this)">游戏与RPG</div>
                        <div class="filter-tag" onclick="toggleTag(this)">广播剧</div>
                        <div class="filter-tag" onclick="toggleTag(this)">有声书与小说</div>
                        <div class="filter-tag" onclick="toggleTag(this)">动漫与动画</div>
                        <div class="filter-tag" onclick="toggleTag(this)">角色配音</div>
                        <div class="filter-tag" onclick="toggleTag(this)">纪录片</div>
                        <div class="filter-tag" onclick="toggleTag(this)">广告与预告</div>
                        <div class="filter-tag" onclick="toggleTag(this)">在线教育</div>
                        <div class="filter-tag" onclick="toggleTag(this)">播客与社媒</div>
                        <div class="filter-tag" onclick="toggleTag(this)">企业宣传与旁白</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-reset" onclick="resetFilters()">重置所有</button>
                <button class="btn-confirm" onclick="applyFilters()" style="padding: 10px 24px;">筛选</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Notification Message</div>

    <script>
        let currentVoiceMode = 'preset';
        let currentPresetName = '沉稳高管';
        let currentCloneName = '';
        
        // 播放相关变量
        let isPlaying = false;
        let playInterval = null;
        let currentProgressPercent = 0;
        const totalDuration = 14; 

        // 库音色试听管理
        let trialPlayingCard = null;

        // 更新滑动条进度填充效果
        function updateSliderProgress(slider) {
            const min = parseFloat(slider.min) || 0;
            const max = parseFloat(slider.max) || 100;
            const value = parseFloat(slider.value) || 0;
            const percent = ((value - min) / (max - min)) * 100;
            
            // 找到对应的进度条元素
            const progressId = 'progress-' + slider.id;
            const progressEl = document.getElementById(progressId);
            if (progressEl) {
                progressEl.style.width = percent + '%';
            }
        }

        // 初始化所有滑动条的进度
        function initSliders() {
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                updateSliderProgress(slider);
                slider.addEventListener('input', function() {
                    updateSliderProgress(this);
                });
            });
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initSliders);

        function switchTab(tabName, cardBodyId) {
            const container = document.getElementById(cardBodyId);
            const tabs = container.parentNode.querySelectorAll('.tab-btn');
            const panelPreset = document.getElementById('panel-preset');
            const panelCloneContainer = document.getElementById('panel-clone-container');
            
            tabs.forEach(t => t.classList.remove('active'));
            if(tabName === 'preset') {
                tabs[0].classList.add('active');
                panelPreset.classList.remove('hidden');
                panelPreset.style.animation = 'fadeIn 0.3s ease-out';
                panelCloneContainer.classList.add('hidden');
                currentVoiceMode = 'preset';
            } else {
                tabs[1].classList.add('active');
                panelPreset.classList.add('hidden');
                panelCloneContainer.classList.remove('hidden');
                panelCloneContainer.style.animation = 'fadeIn 0.3s ease-out';
                currentVoiceMode = 'clone';
            }
        }

        function switchEmotionTab(mode) {
            const tabs = document.querySelectorAll('.control-card:nth-of-type(2) .tab-btn'); 
            const defaultPanel = document.getElementById('emo-default');
            const manualPanel = document.getElementById('emo-manual');
            const refPanel = document.getElementById('emo-reference');
            const textPanel = document.getElementById('emo-text');

            tabs.forEach(t => t.classList.remove('active'));
            defaultPanel.classList.add('hidden');
            manualPanel.classList.add('hidden');
            refPanel.classList.add('hidden');
            if(textPanel) textPanel.classList.add('hidden');

            if (mode === 'default') {
                tabs[0].classList.add('active');
                defaultPanel.classList.remove('hidden');
                defaultPanel.style.animation = 'fadeIn 0.3s ease-out';
            } else if (mode === 'manual') {
                tabs[1].classList.add('active');
                manualPanel.classList.remove('hidden');
                manualPanel.style.animation = 'fadeIn 0.3s ease-out';
            } else if (mode === 'reference') {
                tabs[2].classList.add('active');
                refPanel.classList.remove('hidden');
                refPanel.style.animation = 'fadeIn 0.3s ease-out';
            } else if (mode === 'text') {
                tabs[3].classList.add('active');
                textPanel.classList.remove('hidden');
                textPanel.style.animation = 'fadeIn 0.3s ease-out';
            }
        }

        function updateVal(input, displayId) {
            if(input.id !== 's-global') document.getElementById('random-emo').checked = false;
            const displayEl = document.getElementById(displayId);
            displayEl.textContent = parseFloat(input.value).toFixed(1);
            // 添加数值变化动画
            displayEl.style.animation = 'none';
            setTimeout(() => {
                displayEl.style.animation = 'bounce 0.3s ease-out';
            }, 10);
            updateSliderProgress(input);
        }
        function resetSlider(sliderId) {
            const slider = document.getElementById(sliderId);
            const defaultVal = sliderId === 's-calm' ? 0.5 : (sliderId === 's-global' ? 1.0 : 0);
            slider.value = defaultVal;
            slider.dispatchEvent(new Event('input'));
        }
        function toggleRandom(checkbox) {
            if(checkbox.checked) {
                ['s-joy', 's-auspicious', 's-anger', 's-depressed', 's-sad', 's-surprise', 's-fear'].forEach(id => {
                    document.getElementById(id).value = (Math.random() * 0.8).toFixed(1);
                    document.getElementById(id).dispatchEvent(new Event('input'));
                });
                showToast("已随机采样情感参数");
            }
        }
        function updateBasicParam(type, val) {
             const displayEl = document.getElementById(type === 'speed' ? 'disp-speed' : 'disp-vol');
             displayEl.textContent = parseFloat(val).toString();
             // 添加数值变化动画
             displayEl.style.animation = 'none';
             setTimeout(() => {
                 displayEl.style.animation = 'bounce 0.3s ease-out';
             }, 10);
             const slider = document.getElementById(type === 'speed' ? 'param-speed' : 'param-vol');
             updateSliderProgress(slider);
        }
        function resetBasicParam(type, defaultVal) {
             const slider = document.getElementById(type === 'speed' ? 'param-speed' : 'param-vol');
             slider.value = defaultVal;
             slider.dispatchEvent(new Event('input'));
        }

        function initVoiceCards() {
            const voiceCards = document.querySelectorAll('.voice-list-container .voice-card');
            voiceCards.forEach(card => {
                // 头像点击逻辑（试听）
                const icon = card.querySelector('.voice-icon');
                if(!icon) return;
                icon.onclick = (e) => {
                    e.stopPropagation(); // 阻止冒泡到 card
                    
                    // 选中音色
                    selectVoice(card);

                    // 切换播放状态
                    if(trialPlayingCard === card) {
                        card.classList.remove('playing');
                        const overlay = card.querySelector('.voice-play-overlay');
                        overlay.innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                        trialPlayingCard = null;
                    } else {
                        if(trialPlayingCard) {
                            trialPlayingCard.classList.remove('playing');
                            trialPlayingCard.querySelector('.voice-play-overlay').innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                        }
                        card.classList.add('playing');
                        card.querySelector('.voice-play-overlay').innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';
                        trialPlayingCard = card;
                        showToast(`正在试听: ${card.getAttribute('data-name')}`);
                    }
                };

                // 卡片整体点击逻辑（仅选中）
                card.onclick = function() {
                    selectVoice(this);
                };
            });
        }

        // Load Data from LocalStorage
        function loadLibraryData() {
            const voices = JSON.parse(localStorage.getItem('tts_voice_lib'));
            const emotions = JSON.parse(localStorage.getItem('tts_emotion_lib'));

            if (voices && voices.length > 0) {
                const container = document.querySelector('.voice-list-container');
                container.innerHTML = voices.map((v, index) => `
                    <div class="voice-card ${index === 0 ? 'active' : ''}" data-name="${v.name}" data-color="${v.color}">
                        <div class="voice-icon ${v.color}">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                            <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                        </div>
                        <div class="voice-info"><div class="voice-name">${v.name}</div><div class="voice-tag">${v.tag || ''}</div></div>
                    </div>
                `).join('');
                
                // Update current selection display if first one is active
                if(voices[0]) {
                     const displayIcon = document.getElementById('current-voice-icon');
                     const displayName = document.getElementById('current-voice-name');
                     displayIcon.className = 'voice-icon ' + voices[0].color;
                     displayName.textContent = voices[0].name;
                }
            }

            if (emotions && emotions.length > 0) {
                const libList = document.querySelector('.lib-list');
                libList.innerHTML = emotions.map(e => `
                    <div class="lib-item" data-name="${e.name}">
                        <div class="voice-icon ${e.color || 'v-blue'}" style="width:48px; height:48px; border-radius:8px; margin-right:0;">
                            <svg class="icon" viewBox="0 0 24 24" style="color:white"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path></svg>
                            <div class="voice-play-overlay"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>
                        </div>
                        <div class="lib-item-info">
                            <div class="lib-item-name">${e.name}</div>
                            <div class="lib-item-desc">${e.desc}</div>
                            <div class="lib-item-tags">
                                ${(e.tags || []).map(t => `<span class="lib-item-tag">${t}</span>`).join('')}
                            </div>
                        </div>
                        <div class="lib-item-actions">
                            <button class="btn-select" onclick="selectEmotionFromLib('${e.name}', '${e.desc}', 'https://api.dicebear.com/7.x/avataaars/svg?seed=${e.id}')">选择</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Re-init listeners
            initVoiceCards();
            initEmotionPlayback();
        }

        function selectVoice(card) {
            voiceCards.forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            // 添加选中动画
            card.style.animation = 'scaleIn 0.3s ease-out';
            const name = card.getAttribute('data-name');
            const colorClass = card.getAttribute('data-color');
            currentPresetName = name;
            const displayIcon = document.getElementById('current-voice-icon');
            const displayName = document.getElementById('current-voice-name');
            // 添加切换动画
            displayIcon.style.animation = 'scaleIn 0.3s ease-out';
            displayName.style.animation = 'fadeIn 0.3s ease-out';
            displayIcon.className = 'voice-icon ' + colorClass;
            displayIcon.style.width = '48px'; displayIcon.style.height = '48px'; displayIcon.style.borderRadius = '12px';
            displayName.textContent = name;
            switchTab('preset', 'voice-card-body');
        }

        function handleFileSelect(input) {
            if(input.files && input.files[0]) {
                const fileName = input.files[0].name;
                currentCloneName = fileName;
                document.getElementById('clone-upload-state').classList.add('hidden');
                document.getElementById('clone-active-state').classList.remove('hidden');
                document.getElementById('custom-voice-name').textContent = fileName;
                showToast(`克隆音色已成功加载: ${fileName}`);
                input.value = '';
            }
        }

        function openEmotionLibrary() {
            document.getElementById('emotion-lib-modal').classList.add('open');
        }
        function closeEmotionLibrary() {
            document.getElementById('emotion-lib-modal').classList.remove('open');
        }
        function selectEmotionFromLib(name, desc, iconSrc) {
            closeEmotionLibrary();
            document.getElementById('emo-btn-group').classList.add('hidden');
            const container = document.getElementById('emo-selected-container');
            container.classList.remove('hidden');
            container.style.animation = 'fadeIn 0.3s ease-out';
            
            document.getElementById('emo-sel-title').textContent = name;
            document.getElementById('emo-sel-desc').textContent = desc;
            
            const iconContainer = document.getElementById('emo-sel-icon');
            iconContainer.innerHTML = `<img src="${iconSrc}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
            
            showToast(`已选择参考情感: ${name}`);
        }
        function resetEmoSelection() {
            document.getElementById('emo-selected-container').classList.add('hidden');
            document.getElementById('emo-btn-group').classList.remove('hidden');
            document.getElementById('emo-btn-group').style.animation = 'fadeIn 0.3s ease-out';
            document.getElementById('file-emo-input').value = '';
        }

        function handleEmoFileSelect(input) {
            if(input.files && input.files[0]) {
                const fileName = input.files[0].name;
                
                document.getElementById('emo-btn-group').classList.add('hidden');
                const container = document.getElementById('emo-selected-container');
                container.classList.remove('hidden');
                container.style.animation = 'fadeIn 0.3s ease-out';
                
                document.getElementById('emo-sel-title').textContent = fileName;
                document.getElementById('emo-sel-desc').textContent = "来源: 本地上传";
                
                const iconContainer = document.getElementById('emo-sel-icon');
                iconContainer.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>`;
                iconContainer.className = 'voice-icon v-orange';
                
                showToast("情感参考音频已加载");
            }
        }

        const textInput = document.getElementById('text-input');
        textInput.addEventListener('input', function() { document.getElementById('char-num').textContent = this.value.length; });

        const emoTextInput = document.getElementById('emotion-text-input');
        if(emoTextInput) {
            emoTextInput.addEventListener('input', function() { document.getElementById('emo-char-num').textContent = this.value.length; });
        }

        function startGeneration() {
            const btn = document.getElementById('btn-generate');
            const btnText = btn.querySelector('.btn-text');
            const resultCard = document.getElementById('result-card');
            const textVal = textInput.value || "这是一个测试生成的文本...";

            if (btn.disabled) return;
            btn.disabled = true;
            const originalText = btnText.textContent;
            btnText.textContent = "生成中...";
            btn.classList.add('loading');
            // 添加按钮点击动画
            btn.style.animation = 'scaleIn 0.2s ease-out';
            resultCard.classList.add('hidden');

            resetPlayback();

            setTimeout(() => {
                btn.disabled = false;
                btnText.textContent = originalText;
                btn.classList.remove('loading');
                resultCard.classList.remove('hidden');
                // 添加结果卡片出现动画
                resultCard.style.animation = 'slideInRight 0.5s ease-out';
                
                // 滚动到底部，确保结果可见
                setTimeout(() => {
                    resultCard.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);
                
                addToHistory(textVal);
                const creditEl = document.getElementById('credit-count');
                const oldValue = parseInt(creditEl.textContent.replace(',', ''));
                creditEl.textContent = (oldValue - 5).toLocaleString();
                // 添加积分变化动画
                creditEl.style.animation = 'shake 0.5s ease-out';
                showToast("生成成功! 消耗 5 积分");
            }, 1800);
        }

        // 播放逻辑
        function togglePlay(btn) {
            const playIcon = btn.querySelector('.play-icon');
            const pauseIcon = btn.querySelector('.pause-icon');
            const progressFill = document.getElementById('audio-progress');
            const timeDisplay = document.getElementById('time-current');

            if (isPlaying) {
                // 暂停
                isPlaying = false;
                btn.classList.remove('isPlaying');
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                clearInterval(playInterval);
            } else {
                // 播放
                isPlaying = true;
                btn.classList.add('isPlaying');
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                
                playInterval = setInterval(() => {
                    currentProgressPercent += (1 / totalDuration) * 10;
                    if (currentProgressPercent >= 100) {
                        currentProgressPercent = 100;
                        resetPlayback();
                    }
                    progressFill.style.width = currentProgressPercent + '%';
                    
                    let currentSecs = Math.floor((currentProgressPercent / 100) * totalDuration);
                    timeDisplay.textContent = `00:${currentSecs.toString().padStart(2, '0')}`;
                }, 100);
            }
        }

        function resetPlayback() {
            isPlaying = false;
            clearInterval(playInterval);
            currentProgressPercent = 0;
            const playBtn = document.getElementById('main-play-btn');
            if(playBtn) {
                playBtn.classList.remove('isPlaying');
                playBtn.querySelector('.play-icon').classList.remove('hidden');
                playBtn.querySelector('.pause-icon').classList.add('hidden');
            }
            const fill = document.getElementById('audio-progress');
            if(fill) fill.style.width = '0%';
            const time = document.getElementById('time-current');
            if(time) time.textContent = '00:00';
        }

        function seekAudio(e) {
            const track = document.getElementById('audio-track');
            const rect = track.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            currentProgressPercent = (x / width) * 100;
            document.getElementById('audio-progress').style.width = currentProgressPercent + '%';
            
            let currentSecs = Math.floor((currentProgressPercent / 100) * totalDuration);
            document.getElementById('time-current').textContent = `00:${currentSecs.toString().padStart(2, '0')}`;
        }

        // 格式化时间为 YYYY-MM-DD HH:mm:ss
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function addToHistory(text) {
            const container = document.getElementById('history-feed-container');
            const activeVoice = currentVoiceMode === 'preset' ? currentPresetName : (currentCloneName || 'Custom_Clone.wav');
            const currentTime = formatDateTime(new Date());
            const itemHTML = `
                <div class="feed-item fade-in">
                    <div class="feed-dot" style="border-color:var(--primary)"></div>
                    <div class="feed-line"></div>
                    <div class="feed-card" onclick="copyTextToInput(this)">
                        <div class="feed-meta"><span>${activeVoice}</span><span>${currentTime}</span></div>
                        <div class="feed-text">${text}</div>
                        <div class="feed-actions"><span class="cost-badge">-5 pts</span><div class="action-icon" onclick="event.stopPropagation(); showToast('已下载')"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div></div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('afterbegin', itemHTML);
            document.getElementById('history-count').textContent = parseInt(document.getElementById('history-count').textContent) + 1;
        }

        function copyTextToInput(card) {
            textInput.value = card.querySelector('.feed-text').textContent;
            textInput.dispatchEvent(new Event('input'));
            showToast('文本已填入输入框');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        let isActivated = false;
        function openActivationModal() {
            if (isActivated) return;
            document.getElementById('activation-modal').classList.add('open');
            document.getElementById('invite-code').focus();
        }
        function closeActivationModal() {
            document.getElementById('activation-modal').classList.remove('open');
        }
        function submitActivationCode() {
            const code = document.getElementById('invite-code').value;
            if(code.length > 0) {
                showToast("激活成功！积分已增加");
                closeActivationModal();
                const creditEl = document.getElementById('credit-count');
                creditEl.textContent = (parseInt(creditEl.textContent.replace(',', '')) + 500).toLocaleString();
                
                const expText = document.getElementById('header-exp-text');
                expText.textContent = "到期时间: 2026/12/31";
                expText.style.color = "var(--text-sub)";
                
                isActivated = true;
                document.getElementById('user-profile-btn').style.cursor = 'default';
            } else {
                showToast("请输入有效的邀请码");
            }
        }

        /* Filter Modal Logic */
        function openFilterModal() {
            document.getElementById('filter-modal').classList.add('open');
        }
        function closeFilterModal() {
            document.getElementById('filter-modal').classList.remove('open');
        }
        function selectSeg(item) {
            const siblings = item.parentNode.querySelectorAll('.seg-item');
            siblings.forEach(s => s.classList.remove('active'));
            item.classList.add('active');
        }
        function toggleTag(tag) {
            tag.classList.toggle('active');
        }
        function resetFilters() {
            document.querySelectorAll('.custom-select').forEach(s => s.selectedIndex = 0);
            const segs = document.querySelectorAll('.segmented-control .seg-item');
            segs.forEach(s => s.classList.remove('active'));
            if(segs.length > 0) segs[0].classList.add('active'); // Default to first
            document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
            showToast("筛选条件已重置");
        }
        function applyFilters() {
            closeFilterModal();
            showToast("筛选已应用");
        }

        // 情绪库筛选逻辑
        function filterEmo(tag) {
            const siblings = tag.parentNode.querySelectorAll('.lib-tag');
            siblings.forEach(t => t.classList.remove('active'));
            tag.classList.add('active');
            showToast(`已筛选: ${tag.textContent}`);
        }

        // 情绪库试听逻辑
        let emotionPlayingItem = null;

        function initEmotionPlayback() {
            const emoItems = document.querySelectorAll('#emotion-lib-modal .lib-item');
            emoItems.forEach(item => {
                const icon = item.querySelector('.voice-icon');
                if(!icon) return;
                
                icon.onclick = (e) => {
                    e.stopPropagation();
                    
                    if(emotionPlayingItem === item) {
                        // Stop
                        item.classList.remove('playing');
                        const overlay = item.querySelector('.voice-play-overlay');
                        overlay.innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                        emotionPlayingItem = null;
                    } else {
                        // Stop previous
                        if(emotionPlayingItem) {
                            emotionPlayingItem.classList.remove('playing');
                            emotionPlayingItem.querySelector('.voice-play-overlay').innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                        }
                        // Play new
                        item.classList.add('playing');
                        item.querySelector('.voice-play-overlay').innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';
                        emotionPlayingItem = item;
                        showToast(`正在试听: ${item.getAttribute('data-name')}`);
                    }
                };
            });
        }
        
        // Add to initialization
        document.addEventListener('DOMContentLoaded', initEmotionPlayback);
        
        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const iconContainer = document.getElementById('theme-icon');
            if (isDark) {
                // Sun Icon
                iconContainer.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            } else {
                // Moon Icon
                iconContainer.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            }
        }

        // Init Theme
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
                // Wait for DOMContentLoaded to update icon if element not ready, 
                // but script is at bottom so it should be fine.
                // However, icon element might not be parsed if this script runs too early?
                // No, script is at bottom.
                const icon = document.getElementById('theme-icon');
                if(icon) updateThemeIcon(true);
            }
        })();
    </script>
</body>
</html>